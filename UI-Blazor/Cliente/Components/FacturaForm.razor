@using UI_Blazor.Client.Services
@using UI_Blazor.Client.Models
@using FacturaModel = UI_Blazor.Client.Models.Factura
@using Models = UI_Blazor.Client.Models
@inject IClienteService ClienteService
@inject IProductoService ProductoService

<div class="factura-form-container">
    <h3 class="modal-title">@(Factura.Id_Fac == 0 ? "Nueva Factura" : "Editar Factura")</h3>

    <EditForm Model="@Factura" OnValidSubmit="CalcularTotales">
        <div class="form-grid">
            <!-- Primera fila: Fecha, Cliente -->
            <div class="form-row">
                <div class="form-group">
                    <label>Fecha Emisi贸n</label>
                    <InputDate @bind-Value="Factura.Fec_Fac" />
                </div>
                <div class="form-group">
                    <label>Cliente *</label>
                    <InputSelect @bind-Value="Factura.Id_Cli_Per" @bind-Value:after="OnClienteChanged">
                        <option value="0">Seleccionar cliente...</option>
                        @foreach (var c in clientes)
                        {
                            <option value="@c.Id_Cli">@c.NombreCompleto - @c.Num_Documento</option>
                        }
                    </InputSelect>
                    <button type="button" class="btn-small">+ Nuevo cliente</button>
                </div>
            </div>

            <!-- L铆neas de productos -->
            <h4>Detalles de Factura</h4>
            <table class="lineas-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detalle in Factura.Detalles)
                    {
                        <tr>
                            <td>
                                <InputText @bind-Value="detalle.ProductoNombre" placeholder="Descripci贸n o c贸digo" style="width:100%" />
                            </td>
                            <td><InputNumber @bind-Value="detalle.Cantidad_Comprada" /></td>
                            <td><InputNumber @bind-Value="detalle.Precio_Venta_Unit" step="0.01" /></td>
                            <td>@detalle.Precio_Venta_Total.ToString("N2")</td>
                            <td>
                                <button type="button" @onclick="() => Factura.Detalles.Remove(detalle)" class="btn-danger-small"></button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <button type="button" @onclick="AgregarDetalle" class="btn-add-line">
                + Agregar detalle
            </button>

            <!-- Informaci贸n de Pago y Establecimiento (Campos Futuros en BD) -->
            <div class="payment-section">
                <h4 class="section-title">
                     Informaci贸n de Pago y Establecimiento
                    <span class="future-badge">Pendiente en BD</span>
                </h4>
                
                <div class="payment-grid">
                    <div class="form-group">
                        <label>Establecimiento *</label>
                        <InputSelect @bind-Value="Factura.Establecimiento_Fac">
                            <option value="@Establecimiento.Matriz">Matriz</option>
                            <option value="@Establecimiento.SucursalCentro">Sucursal Centro</option>
                            <option value="@Establecimiento.SucursalNorte">Sucursal Norte</option>
                            <option value="@Establecimiento.SucursalSur">Sucursal Sur</option>
                        </InputSelect>
                    </div>

                    <div class="form-group">
                        <label>Punto de Venta</label>
                        <InputText @bind-Value="Factura.Punto_Venta" placeholder="Ej: PV-001" />
                    </div>

                    <div class="form-group">
                        <label>Forma de Pago *</label>
                        <InputSelect @bind-Value="Factura.Forma_Pago">
                            <option value="@FormaPago.Efectivo">Efectivo</option>
                            <option value="@FormaPago.Tarjeta">Tarjeta</option>
                        </InputSelect>
                    </div>

                    <div class="form-group">
                        <label>Valor de Pago (USD)</label>
                        <InputNumber @bind-Value="Factura.Valor_Pago" step="0.01" placeholder="0.00" />
                    </div>

                    <div class="form-group">
                        <label>Plazo de Pago (d铆as)</label>
                        <InputNumber @bind-Value="Factura.Plazo_Pago_Dias" placeholder="0" />
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="totales-section">
                <div class="total-line"><span>Subtotal:</span> <strong>@Factura.Tot_Fac_Sin_IVA.ToString("C")</strong></div>
                <div class="total-line"><span>IVA 12%:</span> <strong>@Factura.IVA_Fac.ToString("C")</strong></div>
                <div class="total-line highlight"><span>TOTAL A PAGAR:</span> <strong>@Factura.Tot_Fac_Con_IVA.ToString("C")</strong></div>
            </div>

            <div class="form-actions">
                <button type="button" class="action-btn secondary" @onclick="OnCancelar">Cancelar</button>
                <button type="submit" class="action-btn primary-btn">Guardar y Enviar</button>
            </div>
        </div>
    </EditForm>
</div>

<style>
    .payment-section {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: linear-gradient(135deg, #fff9f0 0%, #fff5f8 100%);
        border-left: 4px solid #f59e0b;
        border-radius: 8px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .future-badge {
        font-size: 0.7rem;
        background: #f59e0b;
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 10px;
        font-weight: 500;
    }

    .payment-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    @@media (max-width: 768px) {
        .payment-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    [Parameter] public FacturaModel Factura { get; set; } = new();
    [Parameter] public EventCallback OnGuardar { get; set; }
    [Parameter] public EventCallback OnCancelar { get; set; }

    private List<Models.Cliente> clientes = new();

    protected override async Task OnInitializedAsync()
    {
        clientes = await ClienteService.GetClientesAsync();
    }

    private void AgregarDetalle()
    {
        Factura.Detalles.Add(new DetalleFactura());
    }

    private void OnClienteChanged()
    {
        // Update ClienteNombre when Id_Cli_Per changes
        var clienteSeleccionado = clientes.FirstOrDefault(c => c.Id_Cli == Factura.Id_Cli_Per);
        if (clienteSeleccionado != null)
        {
            Factura.ClienteNombre = clienteSeleccionado.NombreCompleto;
        }
    }

    private void CalcularTotales()
    {
        Factura.Tot_Fac_Sin_IVA = Factura.Detalles.Sum(d => d.Precio_Venta_Total);
        Factura.IVA_Fac = Factura.Tot_Fac_Sin_IVA * 0.12m;
        Factura.Tot_Fac_Con_IVA = Factura.Tot_Fac_Sin_IVA + Factura.IVA_Fac;
        OnGuardar.InvokeAsync();
    }
}