@page "/clientes"
@using Cliente.Components 
@using UI_Blazor.Client.Models
@using UI_Blazor.Client.Services
@inject IClientService ClientService

<PageTitle>Clientes | Dashboard</PageTitle>

<div class="dashboard-header">
    <h2>Gestión de Clientes</h2>
    <div class="header-actions">
        <button class="export-button">Exportar (CSV)</button>
        <button class="import-button">Importar Clientes</button>
    </div>
</div>

<ClienteSummaryCards Clientes="listaClientes" />

<div class="dashboard-content">
    <ClienteFilterBar 
        OnSearchChanged="HandleSearchChanged" 
        OnFilterByTipoChanged="HandleFilterByTipoChanged"
        OnNuevoCliente="HandleNuevoCliente" 
    />
    
    <ClienteTable 
        Clientes="ClientesFiltrados" 
        SearchTerm="@searchTerm"
        OnViewClient="HandleViewClient"
        OnEditClient="HandleEditClient"
        OnDeleteClient="HandleDeleteClient"
    />
</div>

@code {
    private List<Cliente> listaClientes { get; set; } = new();
    private List<Cliente> ClientesFiltrados { get; set; } = new();
    private string searchTerm = string.Empty;
    private TipoCliente? filterTipo = null;

    protected override async Task OnInitializedAsync()
    {
        listaClientes = await ClientService.GetClientsAsync();
        ApplyFilters();
    }
    
    private void ApplyFilters()
    {
        var tempClientes = listaClientes.AsEnumerable();
        
        // 1. Filtrado por tipo de cliente (Dropdown/Botones)
        if (filterTipo.HasValue)
        {
            tempClientes = tempClientes.Where(c => c.Tipo == filterTipo.Value);
        }
        
        // 2. Filtrado por texto (Search Box) - La lógica de búsqueda amplia está en ClienteTable.razor
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            // Para mantener la lógica de búsqueda en un solo lugar (ClienteTable),
            // delegamos la tarea de filtrar por la barra de búsqueda al componente hijo
            // y aquí solo se filtran los Tipos si se seleccionó uno.
            // Opcionalmente, podemos aplicar el filtro de búsqueda aquí antes de pasarlo al componente.
            tempClientes = FilterBySearchTerm(tempClientes.ToList(), searchTerm);
        }
        
        ClientesFiltrados = tempClientes.ToList();
    }

    // Lógica para la búsqueda de texto
    private List<Cliente> FilterBySearchTerm(List<Cliente> source, string term)
    {
        if (string.IsNullOrWhiteSpace(term))
        {
            return source;
        }

        string normalizedTerm = term.Trim().ToLowerInvariant();

        return source.Where(c => 
            c.Nombres.ToLowerInvariant().Contains(normalizedTerm) ||
            c.Apellidos.ToLowerInvariant().Contains(normalizedTerm) ||
            c.NombreComercial.ToLowerInvariant().Contains(normalizedTerm) ||
            c.NumeroIdentificacion.Contains(normalizedTerm) || // Búsqueda exacta en ID (CI, RUC, Pasaporte)
            c.Telefono.Contains(normalizedTerm) ||
            c.Email.ToLowerInvariant().Contains(normalizedTerm)
        ).ToList();
    }


    // Handlers
    private void HandleSearchChanged(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        ApplyFilters();
    }

    private void HandleFilterByTipoChanged(TipoCliente? newFilter)
    {
        filterTipo = newFilter;
        ApplyFilters();
    }

    private void HandleNuevoCliente()
    {
        // Lógica: Navegar a la página de nuevo cliente o abrir un modal
        Console.WriteLine("Abrir formulario para nuevo cliente");
    }

    private void HandleViewClient(int clientId)
    {
        Console.WriteLine($"Ver cliente: {clientId}");
    }
    
    private void HandleEditClient(int clientId)
    {
        Console.WriteLine($"Editar cliente: {clientId}");
    }

    private void HandleDeleteClient(int clientId)
    {
        Console.WriteLine($"Eliminar cliente: {clientId}");
    }
}