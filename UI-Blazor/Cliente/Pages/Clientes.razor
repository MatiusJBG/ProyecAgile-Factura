@page "/clientes"
@page "/clientes/lista"
@attribute [Authorize]
@using Cliente.Components 
@using UI_Blazor.Client.Models
@using UI_Blazor.Client.Services
@inject IClienteService ClienteService
@inject NavigationManager NavigationManager

<PageTitle>Clientes | Dashboard</PageTitle>

<div class="clientes-page">
    <!-- Header con navegación por pestañas -->
    <div class="page-header">
        <div class="header-title-section">
            <h2 class="page-title">Gestión de Clientes</h2>
            <p class="page-subtitle">Administra y visualiza todos tus clientes</p>
        </div>
        <div class="header-actions">
            <button class="action-btn export-btn">
                Exportar CSV
            </button>
            <button class="action-btn import-btn">
                Importar
            </button>
        </div>
    </div>

    <!-- Navegación por pestañas -->
    <div class="tabs-navigation">
        <button class="tab-btn @(currentView == "lista" ? "active" : "")" @onclick='() => ChangeView("lista")'>
            Lista General
        </button>
        <button class="tab-btn @(currentView == "nuevo" ? "active" : "")" @onclick='() => ChangeView("nuevo")'>
            Añadir Cliente
        </button>
    </div>

    <!-- Contenido condicional según la vista -->
    @if (currentView == "lista")
    {
        <div class="content-section">
            <ClienteSummaryCards Clientes="listaClientes" />

            <div class="dashboard-content">
                <ClienteFilterBar 
                    OnSearchChanged="HandleSearchChanged" 
                    OnFilterByTipoChanged="HandleFilterByTipoChanged"
                    OnNuevoCliente='() => ChangeView("nuevo")'
                />
                
                <ClienteTable 
                    Clientes="ClientesFiltrados" 
                    SearchTerm="@searchTerm"
                    OnViewClient="HandleViewClient"
                    OnEditClient="HandleEditClient"
                    OnDeleteClient="HandleDeleteClient"
                />

                @if (ClientesFiltrados.Any())
                {
                    <div class="pagination-section">
                        <div class="pagination-info">
                            Mostrando <strong>@ClientesFiltrados.Count</strong> de <strong>@listaClientes.Count</strong> clientes
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (currentView == "nuevo")
    {
        <div class="content-section">
            <ClienteForm 
                Cliente="nuevoCliente" 
                OnSave="HandleSubmitNuevoCliente" 
                OnCancel='() => ChangeView("lista")' 
            />
        </div>
    }
</div>

@code {
    private List<Cliente> listaClientes { get; set; } = new();
    private List<Cliente> ClientesFiltrados { get; set; } = new();
    private string searchTerm = string.Empty;
    private TipoCliente? filterTipo = null;
    private string currentView = "lista";
    
    private Cliente nuevoCliente = new Cliente 
    { 
        Tipo_Cliente = TipoCliente.PERSONA,
        Tipo_Documento = TipoDocumento.CEDULA
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadClientes();
    }

    private async Task LoadClientes()
    {
        listaClientes = await ClienteService.GetClientesAsync();
        ApplyFilters();
    }

    private void ChangeView(string view)
    {
        currentView = view;
        if (view == "nuevo")
        {
            nuevoCliente = new Cliente 
            { 
                Tipo_Cliente = TipoCliente.PERSONA,
                Tipo_Documento = TipoDocumento.CEDULA
            };
        }
    }

    private void ApplyFilters()
    {
        var tempClientes = listaClientes.AsEnumerable();
        
        if (filterTipo.HasValue)
        {
            tempClientes = tempClientes.Where(c => c.Tipo_Cliente == filterTipo.Value);
        }
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            tempClientes = FilterBySearchTerm(tempClientes.ToList(), searchTerm);
        }
        
        ClientesFiltrados = tempClientes.ToList();
    }

    private List<Cliente> FilterBySearchTerm(List<Cliente> source, string term)
    {
        if (string.IsNullOrWhiteSpace(term))
        {
            return source;
        }

        string normalizedTerm = term.Trim().ToLowerInvariant();

        return source.Where(c => 
            c.Nombre.ToLowerInvariant().Contains(normalizedTerm) ||
            c.Apellido.ToLowerInvariant().Contains(normalizedTerm) ||
            c.Num_Documento.Contains(normalizedTerm) ||
            c.Telefono.Contains(normalizedTerm) ||
            c.Correo.ToLowerInvariant().Contains(normalizedTerm)
        ).ToList();
    }

    private void HandleSearchChanged(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        ApplyFilters();
    }

    private void HandleFilterByTipoChanged(TipoCliente? newFilter)
    {
        filterTipo = newFilter;
        ApplyFilters();
    }

    private async Task HandleSubmitNuevoCliente()
    {
        await ClienteService.CreateClienteAsync(nuevoCliente);
        await LoadClientes();
        ChangeView("lista");
        Console.WriteLine($"Cliente guardado: {nuevoCliente.NombreCompleto}");
    }

    private void HandleViewClient(int clientId)
    {
        Console.WriteLine($"Ver cliente: {clientId}");
    }
    
    private void HandleEditClient(int clientId)
    {
        Console.WriteLine($"Editar cliente: {clientId}");
    }

    private void HandleDeleteClient(int clientId)
    {
        Console.WriteLine($"Eliminar cliente: {clientId}");
    }
}