@page "/productos"
@page "/productos/lista"
@attribute [Authorize]
@using UI_Blazor.Client.Models
@using UI_Blazor.Client.Services
@inject IProductoService ProductoService
@inject NavigationManager NavigationManager

<PageTitle>Productos | Dashboard</PageTitle>

<div class="productos-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-title-section">
            <h2 class="page-title">Gestión de Productos</h2>
            <p class="page-subtitle">Administra tu catálogo de productos y servicios</p>
        </div>
        <div class="header-actions">
            <button class="action-btn export-btn">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Exportar CSV
            </button>
            <button class="action-btn import-btn">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Importar
            </button>
            <button class="action-btn primary-btn" @onclick="AbrirModalNuevoProducto">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Nuevo Producto
            </button>
        </div>
    </div>

    <!-- Barra de búsqueda y filtros -->
    <div class="search-filter-bar">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" 
                   class="search-input" 
                   placeholder="Buscar por código, nombre..."
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @oninput="HandleSearchChange" />
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="clear-btn" @onclick="ClearSearch">×</button>
            }
        </div>
        
        <div class="filter-buttons">
            <select class="filter-select" @bind="filterTipo" @bind:after="ApplyFilters">
                <option value="">Tipo de Producto</option>
                <option value="BIEN">Bienes</option>
                <option value="SERVICIO">Servicios</option>
            </select>
            
            <select class="filter-select" @bind="filterIVA" @bind:after="ApplyFilters">
                <option value="">IVA</option>
                <option value="Gravado0">0%</option>
                <option value="Gravado12">12%</option>
                <option value="Gravado14">14%</option>
                <option value="NoObjetoIVA">No Objeto IVA</option>
                <option value="ExentoIVA">Exento IVA</option>
            </select>
            
            <select class="filter-select" @bind="filterActivo" @bind:after="ApplyFilters">
                <option value="">Estado</option>
                <option value="true">Activos</option>
                <option value="false">Inactivos</option>
            </select>
        </div>
    </div>

    <!-- Cards de resumen -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="card-icon blue">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="22.08" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
            <div class="card-content">
                <span class="card-label">Total Productos</span>
                <span class="card-value">@productosFiltrados.Count</span>
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon green">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                    <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="card-content">
                <span class="card-label">Bienes</span>
                <span class="card-value">@productosFiltrados.Count(p => p.TipoProducto == TipoProducto.BIEN)</span>
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon purple">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="7" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
            <div class="card-content">
                <span class="card-label">Servicios</span>
                <span class="card-value">@productosFiltrados.Count(p => p.TipoProducto == TipoProducto.SERVICIO)</span>
            </div>
        </div>

        <div class="summary-card">
            <div class="card-icon orange">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="card-content">
                <span class="card-label">Valor Total Inventario</span>
                <span class="card-value">$@CalcularValorTotal().ToString("N2")</span>
            </div>
        </div>
    </div>

    <!-- Tabla de productos -->
    <div class="productos-table-container">
        <table class="productos-table">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" @onchange="ToggleAllSelected" />
                    </th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Valor Unitario</th>
                    <th>IVA</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (!productosFiltrados.Any())
                {
                    <tr>
                        <td colspan="9" class="no-data">
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <p>No se encontraron productos</p>
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var producto in productosFiltrados)
                    {
                        <tr class="@(producto.IsSelected ? "selected" : "")">
                            <td class="checkbox-col">
                                <input type="checkbox" @bind="producto.IsSelected" />
                            </td>
                            <td>
                                <div class="codigo-cell">
                                    <strong>@producto.CodigoPrincipal</strong>
                                    @if (!string.IsNullOrEmpty(producto.CodigoAuxiliar))
                                    {
                                        <span class="codigo-aux">@producto.CodigoAuxiliar</span>
                                    }
                                </div>
                            </td>
                            <td><strong>@producto.Nombre</strong></td>
                            <td>
                                <span class="tipo-badge @(producto.TipoProducto == TipoProducto.BIEN ? "bien" : "servicio")">
                                    @producto.TipoProductoTexto
                                </span>
                            </td>
                            <td class="precio-col">$@producto.ValorUnitario.ToString("N2")</td>
                            <td>
                                <span class="iva-badge">@producto.IVATexto</span>
                            </td>
                            <td class="stock-col">
                                @if (producto.TipoProducto == TipoProducto.BIEN)
                                {
                                    <span class="@(producto.Stock <= 10 ? "stock-bajo" : "")">@producto.Stock</span>
                                }
                                else
                                {
                                    <span class="stock-na">N/A</span>
                                }
                            </td>
                            <td>
                                <span class="estado-badge @(producto.Activo ? "activo" : "inactivo")">
                                    @(producto.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td class="actions-col">
                                <button class="action-btn-icon view" @onclick="() => VerProducto(producto.Id)" title="Ver">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="action-btn-icon edit" @onclick="() => EditarProducto(producto.Id)" title="Editar">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                                <button class="action-btn-icon delete" @onclick="() => EliminarProducto(producto.Id)" title="Eliminar">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <!-- Paginación -->
        @if (productosFiltrados.Any())
        {
            <div class="pagination-section">
                <div class="pagination-info">
                    Mostrando <strong>@productosFiltrados.Count</strong> de <strong>@productos.Count</strong> productos
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="15 18 9 12 15 6" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    <button class="pagination-btn active">1</button>
                    <button class="pagination-btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="9 18 15 12 9 6" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Modal Nuevo/Editar Producto -->
    @if (mostrarModal)
    {
        <div class="modal-overlay" @onclick="CerrarModal">
            <div class="modal-container-large" @onclick:stopPropagation>
                <button class="modal-close-btn" @onclick="CerrarModal">×</button>
                <ProductoForm Producto="productoActual" OnGuardar="GuardarProducto" OnCancelar="CerrarModal" />
            </div>
        </div>
    }
</div>

@code {
    private List<Producto> productos = new();
    private List<Producto> productosFiltrados = new();
    private string searchTerm = string.Empty;
    private string filterTipo = string.Empty;
    private string filterIVA = string.Empty;
    private string filterActivo = string.Empty;
    private bool mostrarModal = false;
    private Producto productoActual = new();

    protected override async Task OnInitializedAsync()
    {
        productos = await ProductoService.GetProductosAsync();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filtered = productos.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(p =>
                p.Nombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.CodigoPrincipal.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                p.CodigoAuxiliar.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(filterTipo))
        {
            var tipo = Enum.Parse<TipoProducto>(filterTipo);
            filtered = filtered.Where(p => p.TipoProducto == tipo);
        }

        if (!string.IsNullOrWhiteSpace(filterIVA))
        {
            var iva = Enum.Parse<TipoIVA>(filterIVA);
            filtered = filtered.Where(p => p.IVA == iva);
        }

        if (!string.IsNullOrWhiteSpace(filterActivo))
        {
            var activo = bool.Parse(filterActivo);
            filtered = filtered.Where(p => p.Activo == activo);
        }

        productosFiltrados = filtered.ToList();
    }

    private void HandleSearchChange(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        ApplyFilters();
    }

    private void ToggleAllSelected(ChangeEventArgs e)
    {
        bool isChecked = (bool)(e.Value ?? false);
        foreach (var producto in productosFiltrados)
        {
            producto.IsSelected = isChecked;
        }
    }

    private void AbrirModalNuevoProducto()
    {
        productoActual = new Producto
        {
            TipoProducto = TipoProducto.BIEN,
            IVA = TipoIVA.Gravado12,
            ICE = TipoICE.SinICE,
            IRBPNR = TipoIRBPNR.SinIRBPNR,
            Activo = true,
            Stock = 0
        };
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
    }

    private async Task GuardarProducto()
    {
        if (productoActual.Id == 0)
        {
            await ProductoService.CreateProductoAsync(productoActual);
        }
        else
        {
            await ProductoService.UpdateProductoAsync(productoActual);
        }
        
        productos = await ProductoService.GetProductosAsync();
        ApplyFilters();
        CerrarModal();
    }

    private void VerProducto(int id)
    {
        Console.WriteLine($"Ver producto: {id}");
    }

    private async Task EditarProducto(int id)
    {
        var producto = await ProductoService.GetProductoByIdAsync(id);
        if (producto != null)
        {
            productoActual = producto;
            mostrarModal = true;
        }
    }

    private async Task EliminarProducto(int id)
    {
        if (confirm("¿Está seguro que desea eliminar este producto?"))
        {
            await ProductoService.DeleteProductoAsync(id);
            productos = await ProductoService.GetProductosAsync();
            ApplyFilters();
        }
    }

    private decimal CalcularValorTotal()
    {
        return productosFiltrados
            .Where(p => p.TipoProducto == TipoProducto.BIEN)
            .Sum(p => p.ValorUnitario * p.Stock);
    }

    private bool confirm(string message)
    {
        // En producción, usar JSInterop para mostrar confirmación
        return true;
    }
}