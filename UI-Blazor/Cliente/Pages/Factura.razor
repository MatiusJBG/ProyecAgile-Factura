@page "/facturas"
@page "/facturas/lista"
@attribute [Authorize]
@using UI_Blazor.Client.Models
@using UI_Blazor.Client.Services
@using FacturaModel = UI_Blazor.Client.Models.Factura
@using Cliente.Components
@inject FacturaService FacturaService
@inject NavigationManager Nav

<PageTitle>Facturas | AppInvoice</PageTitle>

<div class="facturas-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-title-section">
            <h2 class="page-title">Gestión de Facturas</h2>
            <p class="page-subtitle">Crea, envía y controla todas tus facturas electrónicas</p>
        </div>
    </div>

    <!-- Navegación por pestañas -->
    <div class="tabs-navigation">
        <button class="tab-btn @(currentView == "lista" ? "active" : "")" @onclick='() => ChangeView("lista")'>
            Lista General
        </button>
        <button class="tab-btn @(currentView == "nuevo" ? "active" : "")" @onclick='() => ChangeView("nuevo")'>
            Nueva Factura
        </button>
    </div>

    <!-- Contenido condicional según la vista -->
    @if (currentView == "lista")
    {
        <!-- Tarjetas de resumen -->
        <div class="summary-cards">
            <div class="summary-card blue">
                <div class="card-content">
                    <span class="card-label">Total Facturas</span>
                    <span class="card-value">@facturas.Count</span>
                </div>
            </div>
            <div class="summary-card green">
                <div class="card-content">
                    <span class="card-label">Cobrado</span>
                    <span class="card-value">@facturas.Where(f => f.Estado == EstadoFactura.Pagada).Sum(f => f.Tot_Fac_Con_IVA):C</span>
                </div>
            </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="search-filter-bar">
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Buscar por cliente..." @bind="searchTerm" @bind:event="oninput" @bind:after="Filtrar" />
            </div>
            <div class="filter-buttons">
                <select @bind="filtroEstado" @bind:after="Filtrar">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Pagada">Pagada</option>
                    <option value="Vencida">Vencida</option>
                    <option value="Anulada">Anulada</option>
                </select>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-container">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>ID Factura</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in facturasFiltradas)
                    {
                        <tr>
                            <td><strong>@f.Id_Fac</strong></td>
                            <td>@f.ClienteNombre</td>
                            <td>@f.Fec_Fac.ToString("dd/MM/yyyy")</td>
                            <td>@f.Tot_Fac_Con_IVA:C</td>
                            <td>
                                <span class="status-badge @GetEstadoClass(f.Estado)">@f.Estado</span>
                            </td>
                            <td class="actions">
                                <button class="action-btn-icon" @onclick="() => VerDetalle(f.Id_Fac)" title="Ver">Ver</button>
                                <button class="action-btn-icon edit" @onclick="() => EditarFactura(f)" title="Editar">Editar</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (currentView == "nuevo")
    {
        <div class="content-section">
            <div class="form-container">
                <div class="form-header">
                    <h3 class="form-title">Nueva Factura</h3>
                    <p class="form-subtitle">Complete la información de la factura</p>
                </div>

                <FacturaForm Factura="facturaActual" OnGuardar="GuardarFactura" OnCancelar='() => ChangeView("lista")' />
            </div>
        </div>
    }
</div>

@code {
    private List<FacturaModel> facturas = new();
    private List<FacturaModel> facturasFiltradas = new();
    private string searchTerm = "";
    private string filtroEstado = "";
    private string currentView = "lista";
    private FacturaModel facturaActual = new();

    protected override async Task OnInitializedAsync()
    {
        facturas = await FacturaService.GetFacturasAsync();
        Filtrar();
    }

    private void Filtrar()
    {
        var query = facturas.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(f =>
                f.ClienteNombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(filtroEstado))
            query = query.Where(f => f.Estado.ToString() == filtroEstado);

        facturasFiltradas = query.ToList();
    }

    private void ChangeView(string view)
    {
        currentView = view;
        if (view == "nuevo")
        {
            facturaActual = new FacturaModel
            {
                Fec_Fac = DateTime.Today,
                Detalles = new() { new DetalleFactura() }
            };
        }
    }

    private void EditarFactura(FacturaModel f)
    {
        facturaActual = f;
        currentView = "nuevo";
    }

    private async Task GuardarFactura()
    {
        if (facturaActual.Id_Fac == 0)
            await FacturaService.CreateAsync(facturaActual);
        else
            await FacturaService.UpdateAsync(facturaActual);

        facturas = await FacturaService.GetFacturasAsync();
        Filtrar();
        ChangeView("lista");
    }
    
    private void VerDetalle(int id) => Nav.NavigateTo($"/factura/{id}");

    private string GetEstadoClass(EstadoFactura estado)
    {
        return estado.ToString().ToLower().Replace(" ", "-");
    }
}